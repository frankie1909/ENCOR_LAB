---
- name: Fetch all security rules from PAN-OS Firewall
  hosts: '{{ target | default("firewall") }}'
  connection: local
  gather_facts: false

  vars:
    device:
      ip_address: '{{ ip_address }}'
      username: '{{ username | default(omit) }}'
      password: '{{ password | default(omit) }}'
      api_key: '{{ api_key | default(omit) }}'

  tasks:
    - name: Fetch all security rules
      paloaltonetworks.panos.panos_op:
        provider: '{{ device }}'
        cmd: 'show running security-policy'
      register: result

    - name: Parse security rules XML
      xml:
        xmlstring: '{{ result.stdout_xml }}'
        xpath: '/response/result/rule-base/entry/rules/entry'
        content: text
      register: rules

    - name: Convert security rules to Markdown
      set_fact:
        rules_md: |
          | Rule Name | Source Zone | Destination Zone | Source Address | Destination Address | Action |
          |-----------|-------------|------------------|----------------|---------------------|--------|
          {% for rule in rules.matched %}
          | {{ rule['name'] }} | {{ rule['from']['member'] | join(', ') }} | {{ rule['to']['member'] | join(', ') }} | {{ rule['source']['member'] | join(', ') }} | {{ rule['destination']['member'] | join(', ') }} | {{ rule['action'] }} |
          {% endfor %}

    - name: Save security rules to Markdown file
      copy:
        content: '{{ rules_md }}'
        dest: '../configs/security_rules.md'
